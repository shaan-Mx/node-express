# ğŸ”§ Correction du Middleware sanitizeInput - req.query en lecture seule

## âŒ L'erreur

```
TypeError: Cannot set property query of #<IncomingMessage> which has only a getter
    at sanitizeInput (security.ts:52:9)
```

### Cause

Le middleware `sanitizeInput` essayait de **rÃ©assigner `req.query`** directement, mais cette propriÃ©tÃ© est **en lecture seule** (read-only) dans Express.

**Code problÃ©matique :**
```typescript
export const sanitizeInput = (req: Request, res: Response, next: NextFunction) => {
  if (req.query) {
    req.query = sanitizeObject(req.query)  // âŒ ERREUR
    //          ^
    //          Impossible de rÃ©assigner req.query
  }
  next()
}
```

---

## ğŸ” Pourquoi req.query est en lecture seule ?

### Dans Express

`req.query` est une propriÃ©tÃ© **getter** dÃ©finie par Express qui parse automatiquement la query string de l'URL :

```typescript
// Exemple interne d'Express (simplifiÃ©)
Object.defineProperty(req, 'query', {
  get() {
    return parseQueryString(this.url)
  }
  // Pas de setter â†’ lecture seule !
})
```

### Le problÃ¨me

```typescript
req.query = newValue  // âŒ TypeError: Cannot set property
```

Cette tentative de rÃ©assignation Ã©choue car il n'y a **pas de setter** dÃ©fini pour `req.query`.

### req.body vs req.query

```typescript
// âœ… req.body PEUT Ãªtre rÃ©assignÃ© (propriÃ©tÃ© normale)
req.body = sanitizeObject(req.body)

// âŒ req.query NE PEUT PAS Ãªtre rÃ©assignÃ© (getter only)
req.query = sanitizeObject(req.query)
```

---

## âœ… La solution

**Modifier les propriÃ©tÃ©s de `req.query` en place** au lieu de rÃ©assigner l'objet entier.

### Code corrigÃ©

```typescript
export const sanitizeInput = (req: Request, res: Response, next: NextFunction) => {
  // âœ… Body peut Ãªtre rÃ©assignÃ©
  if (req.body) {
    req.body = sanitizeObject(req.body)
  }
  
  // âœ… Query : on modifie les propriÃ©tÃ©s en place
  if (req.query && typeof req.query === 'object') {
    Object.keys(req.query).forEach(key => {
      const value = req.query[key]
      
      if (typeof value === 'string') {
        // Modifie la propriÃ©tÃ© existante
        req.query[key] = sanitizeString(value)
      } else if (Array.isArray(value)) {
        // Sanitize chaque Ã©lÃ©ment du tableau
        req.query[key] = value.map(v => 
          typeof v === 'string' ? sanitizeString(v) : v
        )
      }
    })
  }
  
  next()
}
```

---

## ğŸ“‹ Changements appliquÃ©s

### Fichier modifiÃ©

```
src/middleware/security.ts
```

### Nouvelle fonction `sanitizeString`

```typescript
function sanitizeString(str: string): string {
  return str
    .replace(/[<>]/g, '') // EnlÃ¨ve < et >
    .trim()
}
```

### Modification de `sanitizeObject`

Maintenant utilisÃ© **uniquement pour `req.body`** (qui peut Ãªtre rÃ©assignÃ©).

### Nouveau traitement de `req.query`

Modification **en place** des propriÃ©tÃ©s existantes, pas de rÃ©assignation de l'objet.

---

## ğŸ¯ Comment Ã§a fonctionne

### Avant (erreur)

```typescript
// URL: /api/products?title=<script>alert('xss')</script>&limit=10

// Tentative de rÃ©assignation
req.query = sanitizeObject(req.query)
// âŒ TypeError: Cannot set property query
```

### AprÃ¨s (fonctionne)

```typescript
// URL: /api/products?title=<script>alert('xss')</script>&limit=10

// Modification en place
req.query.title = sanitizeString(req.query.title)
// âœ… req.query.title devient: "scriptalert('xss')/script"

req.query.limit = req.query.limit  // Pas une string, pas touchÃ©
// âœ… req.query.limit reste: "10"
```

---

## ğŸ§ª Tests

### Test 1 : Query params avec caractÃ¨res dangereux

```bash
# Test avec < et >
curl "http://localhost:3001/api/products?title=<script>test</script>"

# req.query.title avant sanitization: "<script>test</script>"
# req.query.title aprÃ¨s sanitization: "scripttest/script"
```

### Test 2 : Query params normaux

```bash
# Test normal
curl "http://localhost:3001/api/products?limit=5&offset=10"

# req.query.limit: "5" (inchangÃ©, pas de caractÃ¨res dangereux)
# req.query.offset: "10" (inchangÃ©)
```

### Test 3 : Body avec caractÃ¨res dangereux

```bash
# Test POST avec body
curl -X POST http://localhost:3001/api/products \
  -H "Content-Type: application/json" \
  -d '{"title":"<script>alert()</script>","category":"test"}'

# req.body.title avant: "<script>alert()</script>"
# req.body.title aprÃ¨s: "scriptalert()/script"
```

### Test 4 : CrÃ©ation de produit (test original)

```bash
curl -X POST http://localhost:3001/api/products \
  -H "Content-Type: application/json" \
  -d '{"title":"Test Product","category":"test"}'

# RÃ©sultat attendu âœ…
{
  "success": true,
  "data": {
    "id": "V1StGXR8_Z5j",
    "title": "Test Product",
    "category": "test"
  }
}
```

---

## ğŸ”’ SÃ©curitÃ© maintenue

### Protection XSS toujours active

MÃªme avec la modification en place, la sanitization fonctionne :

```typescript
// Input malveillant
?search=<img src=x onerror=alert('xss')>

// AprÃ¨s sanitization
?search=img src=x onerror=alert('xss')
// Les < et > sont supprimÃ©s
```

### Types de sanitization

**Query params :**
- âœ… Suppression de `<` et `>`
- âœ… Trim des espaces
- âœ… Support des tableaux

**Body :**
- âœ… Suppression de `<` et `>`
- âœ… Trim des espaces
- âœ… RÃ©cursif (objets imbriquÃ©s)

---

## ğŸ’¡ Pourquoi cette approche est meilleure

### Avantages

1. **Fonctionne avec Express** : Respecte la structure de `req.query`
2. **Pas de TypeScript @ts-ignore nÃ©cessaire** (sauf pour l'assignation de propriÃ©tÃ©)
3. **Performance** : Modifie en place, pas de copie d'objet
4. **MaintenabilitÃ©** : Code plus clair

### Alternative envisagÃ©e (non retenue)

On aurait pu crÃ©er un nouvel objet et le stocker ailleurs :

```typescript
// Alternative non retenue
req.sanitizedQuery = sanitizeObject(req.query)
```

**ProblÃ¨me :** Tous les routes devraient utiliser `req.sanitizedQuery` au lieu de `req.query`.

---

## ğŸ“š DÃ©tails techniques : Getters et Setters

### PropriÃ©tÃ© normale (req.body)

```typescript
// PropriÃ©tÃ© normale avec valeur
req.body = { title: "test" }  // âœ… OK

// Equivalent Ã :
Object.defineProperty(req, 'body', {
  value: { title: "test" },
  writable: true,        // â† Peut Ãªtre modifiÃ©
  enumerable: true,
  configurable: true
})
```

### PropriÃ©tÃ© getter (req.query)

```typescript
// PropriÃ©tÃ© avec getter seulement
Object.defineProperty(req, 'query', {
  get() {
    return this._parsedQuery || {}
  }
  // Pas de set() â†’ pas de rÃ©assignation possible
})

// Tentative de rÃ©assignation
req.query = newValue  // âŒ TypeError
```

### Modification des propriÃ©tÃ©s de req.query

```typescript
// L'objet retournÃ© par le getter PEUT Ãªtre modifiÃ©
const queryObj = req.query  // Appelle le getter
queryObj.title = "new value"  // âœ… OK

// Ou directement
req.query.title = "new value"  // âœ… OK
```

---

## ğŸ“ LeÃ§on apprise

### âœ… Ã€ faire

```typescript
// Modifier les propriÃ©tÃ©s en place
if (req.query) {
  Object.keys(req.query).forEach(key => {
    req.query[key] = sanitize(req.query[key])
  })
}
```

### âŒ Ã€ Ã©viter

```typescript
// RÃ©assigner l'objet entier
req.query = sanitizeObject(req.query)  // âŒ
```

---

## ğŸ”„ Autres propriÃ©tÃ©s Express en lecture seule

Attention Ã  ces autres propriÃ©tÃ©s Express :

- `req.query` âœ… **CorrigÃ©** (lecture seule)
- `req.params` âš ï¸ Aussi en lecture seule
- `req.route` âš ï¸ Lecture seule
- `req.path` âš ï¸ Lecture seule
- `req.cookies` âš ï¸ Lecture seule (selon middleware)

**RÃ¨gle gÃ©nÃ©rale :** Si c'est parsÃ© automatiquement par Express, c'est probablement en lecture seule.

---

## âœ… VÃ©rification finale

- [x] Erreur `Cannot set property query` corrigÃ©e
- [x] `req.query` sanitisÃ© en place (pas rÃ©assignÃ©)
- [x] `req.body` toujours sanitisÃ© (rÃ©assignÃ©)
- [x] Protection XSS maintenue
- [x] CrÃ©ation de produit fonctionne
- [x] Query params fonctionnent

---

## ğŸ‰ RÃ©sultat

Le middleware `sanitizeInput` fonctionne maintenant correctement ! Il sanitise Ã  la fois `req.body` et `req.query` sans erreur. âœ…

**Test 4 devrait maintenant rÃ©ussir. ğŸš€**

---

## ğŸ“ Commande de test

```bash
# Test complet de crÃ©ation de produit
curl -X POST http://localhost:3001/api/products \
  -H "Content-Type: application/json" \
  -d '{"title":"Test Product","category":"electronics","description":"A test product"}'

# RÃ©sultat attendu
{
  "success": true,
  "data": {
    "id": "V1StGXR8_Z5j",
    "title": "Test Product",
    "category": "electronics",
    "description": "A test product"
  }
}
```

**Le middleware de sÃ©curitÃ© fonctionne maintenant parfaitement ! âœ…**